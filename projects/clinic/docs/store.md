# مخزن البيانات والاتصال (Data Store & Backend)

يعتمد نظام العيادات على طبقة بيانات ذكية وهجينة تجمع بين بساطة REST API وقوة WebSockets للبيانات الحية.

## 1. واجهة REST API (`mishkah-rest.js`)

هذه هي الطبقة الكلاسيكية للتعامل مع الخادم. توفر واجهة بسيطة وموحدة لعمليات CRUD القياسية.

### الميزات

- **`M.REST.repo('table_name')`**: تعطي واجهة برمجية فورية لأي جدول دون إعداد مسبق.
- **دوال جاهزة**: `search`, `get`, `create`, `update`, `delete`.
- **دعم الفروع**: تقوم تلقائياً بدمج `branch_id` في كل الطلبات.

```javascript
// مثال: جلب قائمة المرضى
var repo = M.REST.repo('clinic_patients');
var result = await repo.search({ q: 'Ahmed', limit: 10 });
```

## 2. المخزن الحي (`mishkah.store.js`)

هذا هو القلب النابض للنظام الذي يوفر تجربة **Realtime**. بدلاً من طلب البيانات كل مرة، يحافظ المتصفح على نسخة محلية متزامنة مع الخادم.

### الميزات

- **Hybrid WebSockets**: النظام ذكي؛ قد يقوم بجلب البيانات الأولية عبر REST (للسرعة والاستفادة من الكاش)، ثم يفتح اتصال WebSocket لاستقبال التحديثات فقط (Diffs).
- **التزامن (Synchronization)**: أي تغيير يقم به مستخدم آخر ينعكس فوراً على شاشتك.
- **SQL Mini ORM**: يوفر طرق استعلام تشبه SQL ولكن في المتصفح (`store.query`, `store.insert`).

## 3. المخزن المبسط (`mishkah.simple-store.js`)

طبقة تجريد (Abstraction Layer) فوق المخزن الحي لتبسيط التعامل معه.

- **`createDBAuto`**: يقرأ الـ `schema` وينشئ كائنات JS تمثل الجداول تلقائياً.
- **`db.watch`**: دالة قوية تسمح بمراقبة جدول معين، وتنفيذ كود كلما تغيرت البيانات (Reactive Programming).

### فلسفة الـ Backend الذكي

الـ Backend ليس مجرد مخزن بيانات صامت. هو يعمل بنظام **Intercept Logic**:

1. يستقبل طلب الحفظ (سواء عبر REST أو WS).
2. يطبق قواعد العمل (Validation).
3. يحفظ البيانات في SQL.
4. يبت (Broadcast) التغيير لكل المتصلين المعنيين.

هذا المزيج يضمن:

- **سرعة REST** في التحميل الأولي.
- **حيوية WebSocket** في التحديثات.
- **صرامة SQL** في حفظ البيانات.
