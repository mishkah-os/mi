<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Brocker v2 - Mobile Kit</title>
    <meta name="description" content="ÿ™ÿ¨ÿ±ÿ®ÿ© ÿπŸÇÿßÿ±ÿßÿ™ ÿßÿ¨ÿ™ŸÖÿßÿπŸäÿ© ŸÖÿ®ŸÜŸäÿ© ÿπŸÑŸâ Schema-first ŸÖÿπ ŸÖŸÉŸàŸÜÿßÿ™ ŸÖŸàÿ®ÿßŸäŸÑ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©." />
    <meta name="theme-color" content="#0b0f1a" />
    <link rel="manifest" href="/api/pwa/aqar/brocker/manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--mk-bg, #0b0f1a);
        color: var(--mk-text, #e2e8f0);
      }
      #app {
        min-height: 100vh;
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
    <!-- Load Mishkah libraries individually for better control -->
    <script src="../../lib/mishkah-utils.js"></script>
    <script src="../../lib/mishkah.core.js"></script>
    <script src="../../lib/mishkah-ui.js"></script>
    <script src="../../lib/mishkah-schema.js"></script>
    <script src="../../lib/mishkah.store.js"></script>
    <script src="../../lib/mishkah.simple-store.js"></script>
    <script src="../../lib/mobile-kit.js"></script>
    <script src="../../lib/mishkah.media-stream.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script>
      // Initialize Brocker v2 with scaffold pattern (like pos.js)
      (async function initBrockerV2() {
        try {
          console.log('üöÄ [Brocker v2] Starting initialization...');

          // Get URL params
          const params = new URLSearchParams(window.location.search || '');
          const BRANCH_ID = params.get('branch') || params.get('branchId') || 'aqar';
          const MODULE_ID = params.get('module') || params.get('moduleId') || 'brocker';
          const mockMode = params.get('mock') === '1';

          // Get language from preferences
          let currentLang = 'ar';
          try {
            const prefs = JSON.parse(localStorage.getItem('brocker:prefs:v2') || '{}');
            currentLang = prefs.lang || 'ar';
          } catch (e) {
            currentLang = 'ar';
          }

          if (mockMode) {
            console.log('üß™ [Brocker v2] Mock mode enabled.');
            window.__BROCKER_MODULE_ENTRY__ = { schema: { tables: [] } };
            window.__BROCKER_BRANCH_ID__ = BRANCH_ID;
            window.__BROCKER_MODULE_ID__ = MODULE_ID;

            const mockListings = [
              {
                id: 'listing-1',
                headline: 'ÿ¥ŸÇÿ© ŸÅÿßÿÆÿ±ÿ© ŸÅŸä ÿßŸÑŸÖÿπÿßÿØŸä',
                listing_type: 'sale',
                price_amount: 2400000,
                currency: 'EGP',
                region_name: 'ÿßŸÑŸÖÿπÿßÿØŸä',
                primary_media_url: 'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1200&q=80',
                likes_count: 18,
                comments_count: 4
              },
              {
                id: 'listing-2',
                headline: '⁄§ŸäŸÑÿß ÿπÿµÿ±Ÿäÿ© ÿ®ÿßŸÑÿ™ÿ¨ŸÖÿπ',
                listing_type: 'rent',
                price_amount: 58000,
                currency: 'EGP',
                region_name: 'ÿßŸÑÿ™ÿ¨ŸÖÿπ ÿßŸÑÿÆÿßŸÖÿ≥',
                primary_media_url: 'https://images.unsplash.com/photo-1502005097973-6a7082348e28?auto=format&fit=crop&w=1200&q=80',
                likes_count: 42,
                comments_count: 9
              }
            ];

            window.__BROCKER_DB__ = {
              watch(name, handler) {
                if (name === 'listings') handler(mockListings);
              },
              status(handler) {
                handler('ready');
              },
              ready() {
                return Promise.resolve();
              }
            };
          } else {
            // Fetch schema
            console.log('üì° [Brocker v2] Fetching schema from /api/schema...');
            const schemaParams = new URLSearchParams({
              branch: BRANCH_ID,
              module: MODULE_ID
            });
            const schemaResponse = await fetch(`/api/schema?${schemaParams.toString()}`);
            const schemaPayload = await schemaResponse.json();
            const moduleEntry = schemaPayload?.modules?.[MODULE_ID];

            if (!moduleEntry || !moduleEntry.schema) {
              throw new Error(`Schema for module "${MODULE_ID}" not found`);
            }

            console.log('‚úÖ [Brocker v2] Schema loaded');
            window.__BROCKER_MODULE_ENTRY__ = moduleEntry;
            window.__BROCKER_BRANCH_ID__ = BRANCH_ID;
            window.__BROCKER_MODULE_ID__ = MODULE_ID;

            // Define tables to watch
            const tables = [
              'listings',
              'listings_lang',
              'regions',
              'brokers',
              'units',
              'unit_types'
            ];

            console.log('üîå [Brocker v2] Creating WebSocket connection...');

            // Create WebSocket connection with window.createDBAuto
            if (typeof window.createDBAuto !== 'function') {
              throw new Error('window.createDBAuto is not available. Make sure mishkah.simple-store.js is loaded.');
            }

            const db = window.createDBAuto(moduleEntry.schema, tables, {
              branchId: BRANCH_ID,
              moduleId: MODULE_ID,
              role: 'brocker-v2',
              lang: currentLang,
              autoReconnect: true,
              historyLimit: 200,
              logger: console
            });

            window.__BROCKER_DB__ = db;
            console.log('‚úÖ [Brocker v2] createDBAuto called, waiting for ready...');

            await db.ready();
            console.log('‚úÖ [Brocker v2] WebSocket ready!');
          }

          // Load app-v2.js dynamically (with cache-busting)
          console.log('üöÄ [Brocker v2] Loading app-v2.js...');
          const script = document.createElement('script');
          const appUrl = new URL('app-v2.js', window.location.href);
          appUrl.searchParams.set('v', Date.now());
          script.src = appUrl.toString();
          document.head.appendChild(script);

        } catch (error) {
          console.error('‚ùå [Brocker v2] Initialization failed:', error);
          document.body.innerHTML = `
            <div style="
              min-height: 100vh;
              display: grid;
              place-items: center;
              font-size: 1.5rem;
              color: #ef4444;
              text-align: center;
              padding: 2rem;
            ">
              <div>
                <h1 style="font-size: 2rem; margin-bottom: 1rem;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</h1>
                <p>${error.message}</p>
              </div>
            </div>
          `;
        }
      })();
    </script>
  </body>
</html>
