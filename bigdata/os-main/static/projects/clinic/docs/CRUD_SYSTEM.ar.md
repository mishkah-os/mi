# توثيق نظام إدارة البيانات (CRUD) والتسمية التلقائية

توضح هذه الوثيقة معمارية نظام إدارة البيانات (CRUD) الموجه بواسطة البيانات وقواعد التسمية التلقائية (Sequences)، باستخدام وحدة **العيادات (Clinic)** كنموذج تطبيقي.

## 1. المعمارية الموجهة بالمخطط (Schema-Driven)

حجر الزاوية في النظام هو تعريف **مخطط JSON** (مثل `clinic_schema.json`). هذا المصدر الوحيد للحقيقة يقود:

1. **هيكلة قاعدة البيانات**: يتم توليد/ترحيل الجداول والأعمدة والعلاقات تلقائيًا.
2. **نقاط اتصال API**: يتم توفير نقاط اتصال CRUD تلقائيًا.
3. **توليد الواجهات (UI)**: تستخدم الواجهة الخلفية البيانات الوصفية `smart_features` و `fields` لرسم النماذج والجداول وعوامل التصفية.

### المكونات الرئيسية لملف `clinic_schema.json`

- **`fields`**: تحدد أنواع البيانات، قواعد التحقق، وتلميحات الواجهة (`labels`, `sort`).
- **`smart_features`**: إعدادات خاصة بالوحدة.
  - `settings.icon`, `settings.colors`: الهوية البصرية للواجهة.
  - `settings.groups`: التجميع المنطقي للحقول في النماذج (مثل: "البيانات الأساسية"، "بيانات الاتصال").
- **`smart_features.sequences`**: تعريف قواعد الترقيم التلقائي لحقول محددة.

---

## 2. قواعد التسمية التلقائية (Sequences)

يستخدم النظام `SequenceManager` مرن (الموجود في `os/src/sequenceManager.js`) لتوليد معرفات فريدة ومقروءة (مثل `PAT-00001` أو `INV-2024-005`).

### الإعداد (Configuration)

يتم تعريف التسلسلات في قسم `smart_features.sequences` داخل المخطط أو في ملف قواعد تسلسل منفصل.

#### مثال للإعداد (من جدول `clinic_patients`)

```json
"sequences": {
  "patient_code": {
    "start": 1,
    "prefix": "PAT",
    "padding": 5,
    "delimiter": "-",
    "preview_label": {
      "ar": "تسلسل تلقائي",
      "en": "Auto sequence"
    }
  }
}
```

#### الخيارات المدعومة

| الخيار | الوصف | مثال |
| :--- | :--- | :--- |
| `start` | رقم البداية للتسلسل. | `1` |
| `prefix` | نص ثابت يظهر قبل الرقم. | `"PAT"`, `"INV"` |
| `suffix` | نص ثابت يظهر بعد الرقم. | `"-A"` |
| `padding` | العرض الكلي للجزء الرقمي (حشو بالأصفار). | `5` (ينتج `00001`) |
| `delimiter` | الفاصل بين الأجزاء (البادئة، التاريخ، الرقم). | `"-"`, `"/"` |
| `dateFormat` | (اختياري) تنسيق التاريخ لتضمينه في المعرف. | `"YYYYMM"`, `"YYYY"` |
| `reset` | (اختياري) سياسة إعادة التعيين. "daily" لتصفير العداد يوميًا. | `"daily"` |

### كيف يعمل؟

1. **المحفز (Trigger)**: يتم تفعيل المنطق عندما يحتوي الحقل على `default_expr: "sequence:field_name"`.
2. **التوليد**: يقوم النظام بحساب القيمة التالية بناءً على الحالة الحالية (المخزنة في `sequence-state.json`) والقواعد.
3. **الحفظ (Persistence)**: يتم تحديث الحالة بشكل ذري لمنع التكرار.

### مثال للمخرجات

- قاعدة: `prefix="PAT"`, `padding=5`, `delimiter="-"`
  - النتيجة: `PAT-00001`, `PAT-00002`...
- قاعدة: `prefix="INV"`, `dateFormat="YYYY"`, `padding=4`, `delimiter="/"`, `includeDate=true`
  - النتيجة: `INV/2024/0001`

---

## 3. التوطين (الترجمة الرأسية - Vertical Translation)

يتبنى النظام **استراتيجية الترجمة الرأسية**، والتي تختلف عن النهج التقليدي "الأفقي" (مثل أعمدة `name_en`, `name_ar` في نفس الجدول).

### المفهوم

بدلاً من تلويث جدول الكيان الرئيسي بأعمدة متعددة لكل لغة، نستخدم **جدول ترجمة مخصص** (`*_lang`) مرتبط بعلاقة 1-إلى-متعدد مع الجدول الأساسي.

- **الجدول الأساسي** (`clinic_patients`): يخزن "نسخة الحقيقة الواحدة" (المعرفات، التواريخ، الأرقام، المفاتيح الخارجية).
- **جدول الترجمة** (`clinic_patients_lang`): يخزن **كل** المحتوى النصي الذي يختلف باختلاف اللغة.
  - **الهيكلة**: صف واحد لكل لغة لكل كيان.
  - **المفتاح الأساسي (PK)**: مركب من `(entity_id, lang)`.

### الفوائد

1. **القابلية للتوسع**: إضافة لغات جديدة (مثل الفرنسية) دون تغيير مخطط قاعدة البيانات.
2. **الأداء**: يظل الجدول الأساسي خفيفًا وثابت العرض، مما يحسن أداء المسح الضوئي (scan) للتحليلات.
3. **عمارة نظيفة**: فصل "البيانات" عن "المحتوى".

### حقول النظام (System Fields)

تتم إدارة حقول معينة تلقائيًا في جدول الترجمة:

#### `display_name`

- **الغرض**: تمثيل نصي معياري ومخبأ للسجل (مثل "John Doe - PAT-1001").
- **السلوك**:
  - يتم حسابه وحقنه تلقائيًا في جدول `_lang` بواسطة الباك إند (`display-name-cache.js`).
  - **الحقن التلقائي**: يتم إضافة تعريف الحقل تلقائيًا للمخطط في الذاكرة (عبر `SmartSchema`) مع خاصية `is_edit_show: false`. لا حاجة لتعريفه يدويًا في `clinic_schema.json`.
  - يستخدم في البحث والقوائم المنسدلة (Autocomplete).

#### `lang`

- **الغرض**: رمز اللغة (مثل `ar`, `en`).
- **السلوك**: يتم التعامل معه تلقائيًا بواسطة معالج حمولة `_lang` في نظام الـ CRUD API.

---

### 4. البحث المتقدم (Advanced Search)

يدعم النظام البحث في السجلات المرتبطة (Foreign Keys) بشكل ذكي، حيث يتم البحث في الحقول النصية (الاسم، العنوان) وفي السجلات المرتبطة (مثل اسم المريض في جدول الحجوزات).

---

## معيار التصميم الديناميكي (Standard Dynamic Design)

تتميز منصة "مشكاة" بمعيار تصميم ديناميكي فريد لإدارة البيانات وعرضها، يعتمد على مبدأ **"الذكاء في الهيكل" (Intelligence in Structure)** بدلاً من الكود الصلب.

### 1. فلسفة "الافتراضي أولاً" (Defaults First)

يبدأ النظام دائماً بالافتراضات الذكية قبل البحث عن قواعد مخصصة. عند عرض أي سجل (مثلاً في القوائم المنسدلة أو العناوين):

- يقوم النظام تلقائياً بالبحث عن حقول معيارية مثل `name`, `title`, `label`, `full_name`.
- إذا لم يجد، يبحث عن أول حقل نصي غير مرتبط.
- إذا لم يجد، يبحث عن أهم علاقة (Foreign Key) ويعرض اسمها.
- **النتيجة**: يعمل النظام فوراً مع أي جدول جديد دون كتابة سطر كود واحد للعرض.

### 2. المنطق العميق في الخلفية (Deep Backend Logic)

على عكس الأنظمة التقليدية التي تترك منطق العرض للواجهة الأمامية (Frontend)، يقوم المحرك الخلفي (`Hydrator`) بمعالجة البيانات بعمق:

- **Resolve Recursively**: إذا كان السجل يعتمد على سجل آخر (مثلاً: حجز -> مريض -> شركة)، يقوم النظام بجلب وتمثيل البيانات المتداخلة تلقائياً.
- هذا المنطق مركزي وموحد، مما يضمن اتساق البيانات في API والتقارير وواجهة المستخدم.

### 3. التخزين في الهيكل (Structure Storage)

يتم تخزين قواعد العرض المعقدة داخل ملفات المخطط (`schema json`) كبيانات، وليس كدوال برمجية. هذا يسمح بتعديل سلوك النظام وتخصيصه دون إعادة بناء الكود.
مثال `display_rule`:

```json
"display_rule": [
  { "type": "field", "name": "code" },
  { "type": "text", "value": { "ar": " - ", "en": " - " } },
  { "type": "field", "name": "name" }
]
```

### 4. منطق التوطين (i18n Logic)

تم تصميم النظام ليكون **متعدد اللغات من الجذور (Native i18n)**. المنطق المخزن في الهيكل يدعم التوطين بشكل كامل:

- **النصوص الثابتة**: يمكن تعريفها ككائنات `{ "ar": "...", "en": "..." }` ليختار النظام النص المناسب حسب لغة المستخدم.
- **الحقول المترجمة**: يتعرف النظام تلقائياً على جداول الترجمة (`_lang`) ويقوم بدمج القيم المترجمة (مثل اسم المريض بالعربية) في السجل الأصلي قبل تطبيقه في قواعد العرض.
- **النتيجة**: قاعدة عرض واحدة (`display_rule`) تنتج مخرجات مختلفة تماماً (عربي/إنجليزي) بناءً على سياق الطلب فقط.

---

## 4. تكامل واجهة المستخدم (UI Integration)

تقرأ الواجهة الأمامية ملف `clinic_schema.json` لبناء الواجهة ديناميكيًا، مع احترام معمارية الترجمة الرأسية.

- **نماذج متعددة اللغات**: تكتشف الواجهة جداول `_lang` وتقوم بعرض مدخلات مبوبة (Tabs) (مثل "العربية"، "English") للحقول القابلة للترجمة.
- **الحقول المخفية**: حقول النظام مثل `display_name` يجب أن تعرف في المخطط (أو تلقائيًا) بـ `is_edit_show: false` لمنع تلاعب المستخدم.
- **التسمية التلقائية**: الحقول مثل `patient_code` التي تُفعل بواسطة `default_expr: "sequence:..."` تكون للقراءة فقط أو مخفية أثناء الإنشاء.

---

## 5. نقاط اتصال API لحفظ البيانات (Save/Update Endpoints)

### نقاط الاتصال (Endpoints)

تستخدم الواجهة الأمامية المكتبة `M.REST.repo(tableName)` للتفاعل مع API:

#### **إنشاء سجل جديد (Create)**

```javascript
POST /api/v1/crud/{table_name}?branch={branch_id}
```

**مثال:**

```javascript
M.REST.repo('clinic_patients').create(payload, { lang: 'ar' });
// → POST /api/v1/crud/clinic_patients?branch=pt&lang=ar
```

#### **تحديث سجل موجود (Update)**

```javascript
PUT /api/v1/crud/{table_name}/{record_id}?branch={branch_id}
```

**مثال:**

```javascript
M.REST.repo('clinic_patients').update(recordId, payload, { lang: 'ar' });
// → PUT /api/v1/crud/clinic_patients/{id}?branch=pt&lang=ar
```

### هيكلة الحمولة (Payload Structure)

يتم بناء الحمولة بواسطة `buildSavePayload()` في `schema-crud.js`:

```json
{
  "field1": "value1",
  "field2": "value2",
  "_lang": {
    "ar": {
      "name": "محمد أحمد",
      "address": "القاهرة"
    },
    "en": {
      "name": "Mohamed Ahmed",
      "address": "Cairo"
    }
  }
}
```

### آلية التعامل مع الترجمات (`_lang`)

1. **في الواجهة**: تجمع `buildLangPayload()` البيانات من tabs اللغات المختلفة.
2. **في الباك إند**: يتعرف API على مفتاح `_lang` ويقوم بـ:
   - **CREATE**: إنشاء صفوف في جدول `{table}_lang` لكل لغة.
   - **UPDATE**: تحديث أو إنشاء الصفوف المفقودة في جدول `{table}_lang`.

### ملاحظات مهمة

- **حقول Sequence**: يتم تصفيتها تلقائيًا من الحمولة عند الإنشاء (CREATE) لتجنب الاصطدام مع القيم المولدة.
- **حقول النظام**: مثل `created_date`, `modified_date`, `created_by` تُدار تلقائيًا بواسطة الباك إند.
- **Branch Context**: جميع الطلبات تتضمن معامل `branch` لعزل البيانات حسب الفرع.
