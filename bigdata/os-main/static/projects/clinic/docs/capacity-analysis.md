# تحليل هندسة إدارة السعة (Capacity Architecture Analysis)

## 1. الفكرة الأساسية (Concept Deep Dive)

في عيادات العلاج الطبيعي (Physiotherapy)، يختلف نموذج العمل عن العيادات التقليدية.

- **النموذج التقليدي**: طبيب واحد مقابل مريض واحد (1:1). الطبيب هو "عنق الزجاجة" والمورد الوحيد.
- **نموذج العلاج الطبيعي**: طبيب واحد يشرف على عدة مرضى (1:N) بالتوازي.
  - المريض أ يوضع على جهاز شد الفقرات (Traction).
  - المريض ب يقوم بتمارين رياضية.
  - المريض ج يتلقى تحفيزاً كهربائياً (TENS).
  - الطبيب يتنقل بينهم.

الـ **Capacity** هنا ليست رقماً ثابتاً للطبيب فقط، بل هي دالة معقدة:
`Booking Possibility = (Doctor Available Capacity > 0) AND (Required Device/Station Available)`

---

## 2. الوضع الحالي (Current Architecture)

بناءً على التوثيق (`booking-system.md`) والكود (`screen-contracts.js`)، النظام يعمل بنمط **Atomic Inventory**:

- الجدول `clinic_slots_inventory` يحتوي على صفوف تمثل "مواعيد".
- الصف الواحد يمثل (طبيب + وقت + محطة/غرفة).
- الحجز (`clinic_bookings`) يقوم بـ "قفل" الصف (`is_booked = 1`).

### هيكل البيانات الحالي (Inferred)

```sql
TABLE clinic_slots_inventory (
    id UUID PRIMARY KEY,
    doctor_id UUID,
    station_id UUID,     -- الغرفة أو الجهاز
    slot_date DATE,
    slot_time_start TIME,
    is_booked BOOLEAN    -- 0 or 1
);
```

---

## 3. المصائب المعمارية والمنطقية (Architectural & Logical Catastrophes)

### المصيبة الأولى: عمى الموارد (Resource Blindness)

إذا قمنا بزيادة "سعة" الطبيب إلى 3 عن طريق إنشاء 3 Slot Rows لنفس التوقيت:

- **السيناريو**: الطبيب لديه 3 مواعيد في الساعة 10:00.
- **الكارثة**: إذا كان الثلاثة يحتاجون لنفس "الجهاز" (مثلاً جهاز واحد للموجات التصادمية Shockwave)، سيسمح النظام بالحجز للثلاثة لأن "سعة الطبيب" تسمح، لكن الواقع الفيزيائي (جهاز واحد) سيمنع التنفيذ. سيضطر مريضان للانتظار، مما يدمر تجربة العميل.
- **التشخيص**: النظام يحسب سعة البشر (الطبيب) ويتجاهل سعة الحديد (الأجهزة).

### المصيبة الثانية: سباق الحجز (Race Conditions)

إذا قررنا استخدام صف واحد مع حقل `capacity = 3`:

- **السيناريو**: السعة المتبقية = 1. موظفتا استقبال تضغطان "حجز" في نفس جزء من الثانية.
- **الكارثة**: كلاهما تقرأ `current_load = 2` (مسموح). كلاهما تضيف حجزاً. النتيجة `load = 4`. حجز زائد (Overbooking).
- **التشخيص**: الاعتماد على القراءة ثم الكتابة (Read-Modify-Write) دون قفل ذري (Atomic Locking) أو إجراءات قاعدة بيانات تضمن الاتساق (Transactions/Constraints).

### المصيبة الثالثة: الجمود الهيكلي (Structural Rigidity)

النظام الحالي يعتمد على "توليد مسبق" (`pre-generation`) للـ Slots.

- **السيناريو**: قررت العيادة شراء جهازين جديدين اليوم لزيادة السعة.
- **الكارثة**: يجب حذف وإعادة توليد آلاف الصفوف في `inventory` للأيام القادمة لتعكس السعة الجديدة. هذا مكلف جداً وحساس للأخطاء (قد نحذف مواعيد محجوزة بالخطأ).
- **التشخيص**: الخلط بين "قواعد السعة" (Rules) و "مخزون السعة" (Inventory).

### المصيبة الرابعة: وهم التوازي (Concurrency Illusion)

الطبيب لا يعالج 3 مرضى في "نفس اللحظة"، بل في "نفس الفترة الزمنية المتداخلة".

- **السنياريو**: 3 مرضى يبدأون الساعة 10:00.
- **الكارثة**: الطبيب يحتاج 10 دقائق لتجهيز كل مريض. المريض الثالث سينتظر 20 دقيقة حتى يأتيه الطبيب، رغم أن موعده 10:00.
- **التشخيص**: عدم توزيع "أوقات البدء" (Staggered Starts). يجب أن تكون المواعيد: 10:00، 10:10، 10:20 لضمان تدفق سلس، حتى لو كانوا في نفس "الساعة".

---

## 4. الحل المعماري المقترح (Proposed Architecture)

للتعامل مع هذا التعقيد، يجب فصل "سعة الطبيب" عن "سعة المكان/الجهاز".

### أ. المستوى الأول: محطات العمل (Workstations Inventory)

بدلاً من `doctor_slots`، نستخدم `station_slots`.

- العيادة بها 5 محطات (3 أسرة، جهاز مشي، جهاز شد).
- نولد Slots لكل **محطة** وليس لكل طبيب.
- الحجز يتم على "المحطة".

### ب. المستوى الثاني: إشراف الطبيب (Doctor Supervision Capacity)

لا نولد Slots للطبيب. بل نضع "قيد" (Constraint) وقت الحجز:
`Check: Count(Active Bookings for Dr. X at Time T) < Max_Capacity`

### نموذج البيانات المقترح (Data Model)

نحتاج لجدولين للتحكم في هذا:

**1. تعريف الموارد (Resources)**

```json
{
  "id": "station-A",
  "type": "bed",
  "capabilities": ["manual_therapy", "electro"]
}
```

**2. مخزون المحطات (Station Inventory - The Hard Constraint)**
هذا الجدول يضمن عدم حجز الجهاز مرتين.

```sql
TABLE clinic_slots_inventory (
    station_id UUID,    -- الأساس هو المحطة
    slot_time TIME,
    is_booked BOOLEAN
    ...
);
```

**3. جدول الحجز (Bookings - The Soft Constraint)**
عند الحجز، نقوم بعملية Transaction:

1. `LOCK` slot row for Station X (prevent double booking of machine).
2. `SELECT COUNT(*)` from bookings WHERE doctor_id = Y AND time = T.
3. `IF count >= 3` THEN rollback (Doctor is busy).
4. `ELSE` commit.

### الحل لمشكلة التداخل (Staggered Starts)

يتم تقسيم الـ Slots بحيث لا تبدأ كلها تماماً في رأس الساعة، أو يتم وضع "Setup Time" إجباري للطبيب في بداية كل جلسة.

## 5. الخلاصة

التعامل مع الـ Capacity برقم ثابت (3) في حقل واحد هو حل "ساذج" (Naive) سيؤدي لمشاكل تشغيلية. الحل الناضج هو اعتبار "المحطة/الجهاز" هو المورد الفيزيائي المحدود (Hard Constraint)، والطبيب هو المورد المرن (Soft Constraint) الذي يدير عدة محطات، مع تطبيق Transaction صارم عند الحجز لمنع الـ Overbooking.
