# شاشة التعاقدات (Contracts Screen)

تعتبر شاشة التعاقدات (`screen-contracts.js`) من أعقد الشاشات في النظام، حيث لا تعتمد فقط على CRUD بل تضم منطق أعمال (Business Logic) كثيف في الـ Frontend.

## 1. استراتيجية تحميل البيانات (Batch Loading)

لضمان سرعة الاستجابة، لا تقوم الشاشة بعمل طلبات API متعددة لكل قائمة منسدلة. بدلاً من ذلك، تعتمد على استراتيجية **Batch Dataset Loading**.

- **الدالة**: `loadContractsReferenceData(app)`
- **الآلية**: ترسل طلب RPC واحد `/api/rpc/batch-dataset` يحتوي على قائمة بكل الجداول المطلوبة (`clinic_doctors`, `clinic_services`, `clinic_patients`, etc).
- **النتيجة**: يتم تخزين البيانات في `app.state.data.referenceData`. هذا يسمح بفتح النماذج (Forms) فوراً دون انتظار تحميل بيانات إضافية.

## 2. منطق الحجوزات والمدد (Slot & Duration Logic)

تحتوي الشاشة على محرك مصغر لحساب مدد الخدمات وتوافر المواعيد:

- **حساب المدة (`resolveActiveServiceMinutes`)**:
  - تقوم الشاشة بحساب المدة المتوقعة للزيارة بناءً على الخدمات المختارة في بنود العقد.
  - الأولوية: مدة الباقة -> مدة الخدمة -> الإعدادات الافتراضية للعيادة -> 15 دقيقة.

- **بناء بلوكات المواعيد (`buildSlotBlocks`)**:
  - تحول قائمة المواعيد الخام (Slots) القادمة من الخادم إلى "كتل" (Blocks) قابلة للحجز.
  - تدمج الفترات الزمنية المتصلة (Contiguous Slots) لتشكيل فترة كافية لمدة الخدمة المطلوبة.

## 3. التعامل مع البيانات المعقدة

- **حل الأسماء (`resolvePatientLabel`)**: منطق ذكي لعرض اسم المريض (يجمع بين الاسم، الكود، ورقم الهاتف) مع دعم تعدد اللغات.
- **تحديث الأسعار**: عند اختيار خدمة، يتم جلب السعر تلقائياً من البيانات المرجعية المحملة مسبقاً، مع مراعاة العروض والباقات.

## 4. واجهة المستخدم (UI Structure)

الشاشة مقسمة إلى ثلاثة أجزاء رئيسية:

1. **القائمة (List View)**: عرض العقود مع فلاتر بحث متقدمة.
2. **المحرر (Editor)**: نموذج معقد (Header/Lines) لإنشاء وتعديل العقود، يشبه نظام الفواتير.
3. **معالج الحجوزات (Booking Wizard)**: واجهة مدمجة لاختيار الموعد المناسب وربطه بالعقد مباشرة.
