<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f4f6;
            padding: 24px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .subtitle {
            color: #6b7280;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        button.secondary {
            background: #6b7280;
        }

        button.secondary:hover {
            background: #4b5563;
        }

        button.success {
            background: #10b981;
        }

        button.success:hover {
            background: #059669;
        }

        .item-row {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }

        .item-row input {
            flex: 1;
        }

        .item-row button {
            flex-shrink: 0;
            padding: 10px 16px;
            background: #ef4444;
        }

        .item-row button:hover {
            background: #dc2626;
        }

        #items-list {
            margin-bottom: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-converted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        #log {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 4px;
        }

        .log-error {
            color: #ef4444;
        }

        .log-success {
            color: #10b981;
        }

        .log-info {
            color: #60a5fa;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—“ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©</h1>
            <p class="subtitle">Full Cycle Test - Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø§Ù„ØªØ£ÙƒÙŠØ¯</p>
        </div>

        <div class="grid">
            <!-- Create Schedule Form -->
            <div class="card">
                <h2 class="card-title">1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯</h2>

                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                    <input type="text" id="customerId" value="CUST-001" />
                </div>

                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
                    <select id="orderType">
                        <option value="dine_in">Ø¯ÙŠÙ† Ø¥Ù†</option>
                        <option value="delivery">ØªÙˆØµÙŠÙ„</option>
                        <option value="takeaway">ØªÙŠÙƒ Ø£ÙˆØ§ÙŠ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø­Ø¬Ø² *</label>
                    <input type="datetime-local" id="scheduledAt" />
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                    <input type="number" id="duration" value="60" min="30" max="180" />
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</label>
                    <input type="text" id="tableIds" value="TBL-001,TBL-002" placeholder="TBL-001, TBL-002" />
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ø£ØµÙ†Ø§Ù</label>
                    <div id="items-list"></div>
                    <button onclick="addItem()" class="secondary">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                </div>

                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="notes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                </div>

                <button onclick="testCreateSchedule()" class="success">âœ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²</button>
            </div>

            <!-- View Schedules -->
            <div class="card">
                <h2 class="card-title">2ï¸âƒ£ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>

                <div class="form-group">
                    <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="statusFilter" onchange="testLoadSchedules()">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="pending" selected>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                        <option value="converted">ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„</option>
                        <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                    </select>
                </div>

                <button onclick="testLoadSchedules()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <button onclick="openReservationsModal()" class="secondary">ğŸ“… ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>

                <div id="schedules-preview" style="margin-top: 16px; max-height: 400px; overflow-y: auto;"></div>
            </div>

            <!-- Actions -->
            <div class="card">
                <h2 class="card-title">3ï¸âƒ£ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>

                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</label>
                    <input type="text" id="scheduleIdAction" placeholder="SCH-PT-XXXXXX" />
                </div>

                <button onclick="testConfirmSchedule()" class="success">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
                <button onclick="testCancelSchedule()" style="background: #ef4444; margin-top: 8px;">âŒ Ø¥Ù„ØºØ§Ø¡
                    Ø§Ù„Ø­Ø¬Ø²</button>
            </div>
        </div>

        <!-- Log Console -->
        <div class="card">
            <h2 class="card-title">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
            <div id="log"></div>
            <button onclick="clearLog()" class="secondary" style="margin-top: 12px;">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
    </div>

    <!-- Include Schedule Module -->
    <script src="schedule-module.js"></script>

    <script>
        // Configuration
        window.POS_CONFIG = {
            branchId: 'pt',
            moduleId: 'pos'
        };

        // Initialize
        let itemsCount = 0;
        let currentSchedules = [];

        // Set default scheduled time (1 hour from now)
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('scheduledAt').value = now.toISOString().slice(0, 16);

        // Add initial item
        addItem();

        // Log function
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const className = `log-${type}`;
            logEl.innerHTML += `<div class="log-entry ${className}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Add item to order
        function addItem() {
            itemsCount++;
            const container = document.getElementById('items-list');
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = `item-${itemsCount}`;
            row.innerHTML = `
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" data-field="name" value="ØµÙ†Ù ${itemsCount}" />
                <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" data-field="qty" value="1" min="1" style="max-width: 80px;" />
                <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" data-field="price" value="${20 + itemsCount * 5}" min="0" step="0.01" style="max-width: 100px;" />
                <button onclick="removeItem(${itemsCount})">ğŸ—‘ï¸</button>
            `;
            container.appendChild(row);
        }

        function removeItem(id) {
            const row = document.getElementById(`item-${id}`);
            if (row) row.remove();
        }

        // Collect items
        function collectItems() {
            const items = [];
            document.querySelectorAll('#items-list .item-row').forEach((row, idx) => {
                const name = row.querySelector('[data-field="name"]').value;
                const qty = parseInt(row.querySelector('[data-field="qty"]').value);
                const price = parseFloat(row.querySelector('[data-field="price"]').value);

                items.push({
                    itemId: `ITEM-${String(idx + 1).padStart(3, '0')}`,
                    name,
                    qty,
                    price,
                    unitPrice: price,
                    quantity: qty
                });
            });
            return items;
        }

        // Calculate totals
        function calculateTotals(items) {
            const subtotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const vat = subtotal * 0.15;
            const service = subtotal * 0.10;
            const due = subtotal + vat + service;

            return {
                subtotal: parseFloat(subtotal.toFixed(2)),
                vat: parseFloat(vat.toFixed(2)),
                service: parseFloat(service.toFixed(2)),
                due: parseFloat(due.toFixed(2))
            };
        }

        // Test: Create Schedule
        async function testCreateSchedule() {
            try {
                log('ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯...', 'info');

                const items = collectItems();
                const totals = calculateTotals(items);

                const tableIdsRaw = document.getElementById('tableIds').value;
                const tableIds = tableIdsRaw ? tableIdsRaw.split(',').map(t => t.trim()) : [];

                const orderData = {
                    customerId: document.getElementById('customerId').value,
                    orderType: document.getElementById('orderType').value,
                    scheduledAt: document.getElementById('scheduledAt').value,
                    duration: parseInt(document.getElementById('duration').value),
                    tableIds: tableIds,
                    lines: items,
                    totals: totals,
                    discount: null,
                    payments: [],
                    notes: document.getElementById('notes').value
                };

                log(`ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${JSON.stringify(orderData, null, 2)}`, 'info');

                const result = await window.ScheduleModule.saveScheduledOrder(orderData);

                log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­: ${result.scheduleId}`, 'success');
                log(`ğŸ“¦ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${JSON.stringify(result, null, 2)}`, 'success');

                // Store last schedule ID
                document.getElementById('scheduleIdAction').value = result.scheduleId;

                // Refresh list
                await testLoadSchedules();

            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Test: Load Schedules
        async function testLoadSchedules() {
            try {
                log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª...', 'info');

                const status = document.getElementById('statusFilter').value;
                const filters = status ? { status } : {};

                const schedules = await window.ScheduleModule.loadScheduledOrders(filters);
                currentSchedules = schedules;

                log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${schedules.length} Ø­Ø¬Ø²`, 'success');

                // Display preview
                const preview = document.getElementById('schedules-preview');
                if (schedules.length === 0) {
                    preview.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</div></div>';
                } else {
                    preview.innerHTML = schedules.map(s => {
                        const payload = s.payload || {};
                        const statusClass = `status-${s.status}`;
                        return `
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <strong>${s.id}</strong>
                                    <span class="status-badge ${statusClass}">${s.status}</span>
                                </div>
                                <div style="font-size: 13px; color: #6b7280;">
                                    ${s.customerName || s.customer_id} | ${payload.lines?.length || 0} ØµÙ†Ù
                                </div>
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Test: Confirm Schedule
        async function testConfirmSchedule() {
            try {
                const scheduleId = document.getElementById('scheduleIdAction').value;
                if (!scheduleId) {
                    log('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²', 'error');
                    return;
                }

                log(`ğŸ“¤ Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²: ${scheduleId}...`, 'info');

                const result = await window.ScheduleModule.confirmScheduledOrder(scheduleId);

                log(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${result.orderId}`, 'success');
                log(`ğŸ“¦ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${JSON.stringify(result, null, 2)}`, 'success');

                // Refresh list
                await testLoadSchedules();

            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Test: Cancel Schedule
        async function testCancelSchedule() {
            try {
                const scheduleId = document.getElementById('scheduleIdAction').value;
                if (!scheduleId) {
                    log('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²', 'error');
                    return;
                }

                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ')) return;

                log(`ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²: ${scheduleId}...`, 'info');

                const result = await window.ScheduleModule.cancelScheduledOrder(scheduleId);

                log(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                log(`ğŸ“¦ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${JSON.stringify(result, null, 2)}`, 'success');

                // Refresh list
                await testLoadSchedules();

            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Open reservations modal
        function openReservationsModal() {
            if (currentSchedules.length === 0) {
                log('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            window.ScheduleModule.handleOpenReservations({ preventDefault: () => { } });
        }

        // Initial load
        log('ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success');
        log('ğŸ“‹ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯', 'info');
    </script>
</body>

</html>