# آلية Flattening للغات (UI Labels + Data)

## لماذا هذا الملف؟
هذا المستند يشرح بالتفصيل مسار «تسطيح» الترجمات من لحظة وجودها في ملفات الـ seeds وحتى لحظة استهلاكها في الواجهة. الهدف هو كشف أسباب ظهور المحتوى مترجماً بينما تبقى الـ UI labels فارغة أو غير مترجمة، وتحديد ما يجب فعله في الواجهة لمعالجة المشكلة.

## نظرة سريعة على المسار
1) **Seeds**: القيم النصية (المحتوى + الـ UI labels) موجودة في `data/branches/sbn/modules/mostamal/seeds/initial.json`.
2) **Schema + ModuleStore**: عند تشغيل السيرفر، `moduleStore.getSnapshot()` يقرأ كل الجداول ويطبق «flattening» أو الدمج التلقائي بين الجداول الأساسية وجداول `_lang` حسب اللغة المطلوبة.
3) **تسطيح المحتوى (tables + `_lang`)**:
   - الدالة `decorateWithTranslations()` في `src/moduleStore.js` تدمج جداول `_lang` فوق الجداول الأساسية (مثلاً `sbn_products` + `sbn_products_lang`).
   - الترجمة تطبق فقط على الحقول النصية الموجودة في جدول `_lang` ويعاد إنتاج صف واحد «مسطح» لكل سجل.
4) **توليد قاموس الـ UI Labels**:
- `getSnapshot()` يبني قاموس i18n من جداول `sbn_ui_labels` و`ui_labels` (لا يوجد جدول `_lang` لهذه الجداول لأنها بالفعل متعددة اللغات بالسجلات).
- القاموس الناتج يُحقن في الاستجابة (`snapshot.i18n`) وترسله الـ API إلى الواجهة.

> ملاحظة: يوجد جدولان (`sbn_ui_labels` و`ui_labels`) يحتويان نفس المفاتيح تقريباً لاعتبارات تاريخية (الفصل بين بيانات الفرع "sbn" والبيانات العامة). حالياً يتم دمجهما معاً في `buildTranslationMaps`، لذا نضطر لزراعة نفس المفاتيح في كلا الجدولين. لتخفيف ازدواجية الصيانة يجب مستقبلاً دمجهما أو إضافة مهمة توليد تلقائي تبقي الجدولين متطابقين.
5) **الواجهة**:
   - في `static/projects/sbn/app.js` يتم دمج قاموس الترجمات في `env.i18n` داخل الـ store عبر `applyI18nToEnv()` و`applyStoreI18n()`.
   - الدوال `translate` / `Mishkah.t` تقرأ من `env.i18n` حسب `env.lang`.

## أين يحدث الخلل الحالي؟
1) **المحتوى يعمل لأن جداول `_lang` مدموجة**: المحتوى (المنتجات، الخدمات، المقالات...) يعتمد على جداول مزدوجة (`table` + `table_lang`) ويتم تسطيحها من الخادم بنجاح، لذا تظهر ترجمات المحتوى.
2) **الـ UI labels ناقصة في الـ seeds**:
   - مفاتيح مثل `home.hero.badge`, `home.hero.title`, `home.hero.subtitle`, `home.action.explore` موجودة في الـ seeds، لكن مفاتيح أخرى مطلوبة حالياً في الواجهة ليست مزروعة أصلاً (مثال: `nav.classifieds`, `categories.classifieds`, `categories.marketplace`, `categories.services`, `classifieds.status.live`, ... إلخ).
   - أثناء البناء، يحصل `buildTranslationMaps` على 0 مفاتيح أو مفاتيح ناقصة في الجولة الأولى، لذا تظهر التحذيرات `[i18n][missing]` مع `availableLocales: []`.
3) **توقيت التحميل في الواجهة**:
   - يتم عرض الهيكل قبل اكتمال دمج الـ store (initial render يحدث قبل وصول `snapshot.i18n`)، فيظهر تحذير مبكر بلا مفاتيح.
   - بعد دمج الـ store، يبقى النقص لأي مفاتيح غير موجودة في الـ seeds، فيستمر التحذير لنفس المفاتيح.

## لماذا تظهر البيانات العادية مترجمة بينما الـ labels لا؟
- **المحتوى**: الخادم يدمج `*_lang` ويعيد صفاً واحداً مترجماً، لذلك ترى العناوين والوصف مترجمة حتى لو حملت الصفحة مبكراً.
- **الـ labels**: تعتمد على قاموس مبني من جدول واحد متعدد اللغات. إذا لم يكن المفتاح موجوداً في `sbn_ui_labels`، فلن يكون هناك أي fallback ذكي على الخادم؛ يتم الاكتفاء بما هو مزروع فقط، ولهذا ترى `availableLocales: []` حتى لو اللغة الحالية `ar`.

## كيفية المعالجة (مستوى الـ Front)
1) **سد الفجوات في الـ seeds**:
   - أضف كل المفاتيح التي يستدعيها الواجهة إلى `sbn_ui_labels` (مثلاً `nav.classifieds`, `categories.classifieds`, `classifieds.cta.contact`, إلخ) مع نص لكل لغة.
   - تأكد من تطابق أسماء المفاتيح مع ما يمرره `translate()` (تحقق من `static/projects/sbn/app.js` وملفات الـ DSL ذات الصلة).
2) **تأخير العرض حتى تجهيز الـ i18n**:
   - استخدم حالة تحميل بسيطة (loader أو skeleton) حتى يصل `snapshot.i18n` ويُدمج في `env.i18n` لتقليل التحذيرات المبكرة.
3) **Fallback داخل الواجهة**:
   - عند الحاجة، أضف fallback محلي في `translate()` ليعود إلى لغة افتراضية (`ar`) أو إلى النص الإنجليزي عند غياب المفتاح، مع تسجيل تحذير واحد فقط.

## خطوات التحقق بعد المعالجة
- شغّل `npm test` للتأكد أن منطق التسطـيح لم ينكسر.
- افتح التطبيق مع `?lang=ar` و `?lang=en` وتحقق من:
  - عدم ظهور تحذيرات `[i18n][missing]` للـ UI labels.
  - توفر `availableLocales` للمفاتيح المطلوبة (على الأقل `['ar', 'en']`).
  - استمرار عمل المحتوى المترجم (المنتجات/الخدمات) بعد الدمج.

## ملخص السبب الجذري
- النظام الحالي لـ auto-flatten يعمل للمحتوى لكنه يعتمد على بيانات كاملة في جدول `sbn_ui_labels` لبناء قاموس الـ UI. غياب مفاتيح مطلوبة في الـ seeds + العرض المبكر قبل دمج القاموس يؤديان إلى تحذيرات وفقدان ترجمة الـ labels، رغم أن المحتوى نفسه مدموج ومترجم.
